# Module 1 设计文档
## 1. 模块目的
1. 将周度/日度需求预测转化为可执行的当日订单与发货计划，并记录因库存不足产生的缺货。
2. 保证发货受真实库存约束：期初库存 + 当日入库（生产收货、调运收货）。
3. 形成面向集成的供需日志，为下游模块与报表提供统一数据来源。
## 2. 适用业务场景
1. Normal Order Generation：按订单日历在指定日期生成客户订单。
2. AO Generation：按物料-地点配置，将未来需求的一部分提前下单。
3. 周转日拆分：将周度预测均匀拆分为日度。
4. 渠道/仓网调整：通过 DPS（预测拆分） 与 Supply Choice（供应选择/微调） 调整需求归属地与数量。
5. 库存约束发货：当日订单仅在“期初+当日入库”范围内发货，超出部分记为缺货。

## 3. 关键业务规则与口径
- 订单日：仅在订单日历标记为“订单日”的日期才会生成订单。
- 周转日拆分：周量平均到 7 天；若除不尽，将余量优先分配到周初的若干天，保证总量一致。
- AO Generation：
    - AO 数量 = 未来平均日需求 × AO百分比；下单日期 = 仿真日 + 提前天数。
    - AO consumption mode：默认在代码中以 AO 下单日为中心，按 “前2天、当天、后3天” 的顺序消耗预测（不使预测为负）。
- 普通订单（normal）：仅在仿真当日消耗对应日期的预测。
- 预测误差：对订单量引入百分比标准差（截断正态，最低为0），缺省时按均值生产订单。
- 库存口径（发货约束）：
    - 可用库存 = 期初库存 + 当日生产收货（GR） + 当日调运收货（GR）；
    - 发货量 = min（当日到期订单量，总可用库存）；剩余即缺货。
- 集成起始日：周转日拆分的起始日期必须与全局 orchestrator.start_date 一致。
- Open order合并：将过往日期生成、但交付日期≥当日的open订单并入当日订单视图，去重后统一发运判定

## 4. 逻辑处理流程
1. 读取配置（M1_* 表）：需求、误差、订单日历、AO、DPS、Supply Choice 等。
2. 规范化订单日历：确认仿真日期是否为订单日。
3. 需求预处理（若为周度）：
    - 先 DPS 拆分（重分配到新的地点）；
    - 再 Supply Choice 调整（对特定日/地/物料微调数量）；
    - 将周度均分到日度（处理余量）；
4. 生成订单（仅订单日）：
    - 按物料-地点对未来 30 天（不足取 7 天）原始预测计算平均日需求；
    - 依据 AO 配置生成 AO 订单；按消费窗口消耗预测；
    - 生成 Normal order；按当日消耗预测。
5. 并入历史未到期订单：合并至当日订单视图并去重,得到open AO
6. 库存约束发货：
    - 从集成服务获取：期初库存、当日生产GR、当日调运GR；
    - 计算可用库存 → 生成 Shipment 与 缺货（Cut）。
7. 供需日志生成：输出仿真日之后的剩余预测（标记 forecast）。
8. 结果落盘：输出 Excel（订单、发货、供需、汇总）。

## 5. 输入数据
### 5.1 M1_DemandForecast
| 字段       | 说明      | 格式 | 备注/来源         |
| -------- | ------- | -- | ------------- |
| material | 物料编码    | 文本 | 配置/主数据        |
| location | 地点/仓库   | 文本 | 配置/主数据        |
| week     | 预测周序号   | 整数 | **周度输入必填**    |
| quantity | 周量（或日量） | 整数 | 周度或日度总量       |
| date     | 日期      | 日期 | **仅当已是日度时出现** |
### 5.2 M1_ForecastError
| 字段                  | 说明         | 格式 | 备注/来源                  |
| ------------------- | ---------- | -- | ---------------------- |
| material            | 物料         | 文本 | —                      |
| location            | 地点         | 文本 | —                      |
| order\_type         | 订单类型       | 文本 | 可取 **AO** / **normal** |
| error\_std\_percent | 误差标准差（百分比） | 小数 | 例：0.2 表示 ±20% 标准差      |

### 5.3 M1_OrderCalendar
| 字段   | 说明     | 格式 | 备注/来源         |
| ---- | ------ | -- | ------------- |
| date | 订单生成日期 | 日期 | 当天若在表内 → 生成订单 |

### 5.4 M1_AOConfig
| 字段            | 说明    | 格式 | 备注/来源             |
| ------------- | ----- | -- | ----------------- |
| material      | 物料    | 文本 | —                 |
| location      | 地点    | 文本 | —                 |
| advance\_days | 提前天数  | 整数 | AO 下单日 = 仿真日 + 此值 |
| ao\_percent   | AO 占比 | 小数 | 例：0.3=30%         |

### 5.5 M1_DPSConfig
| 字段            | 说明   | 格式 | 备注/来源     |
| ------------- | ---- | -- | --------- |
| material      | 物料   | 文本 | —         |
| location      | 原地点  | 文本 | 拆分来源      |
| dps\_location | 目标地点 | 文本 | 拆分去向      |
| dps\_percent  | 拆分比例 | 小数 | 0–1，按周度生效 |

### 5.6 M1_SupplyChoiceConfig
| 字段               | 说明        | 格式 | 备注/来源   |
| ---------------- | --------- | -- | ------- |
| material         | 物料        | 文本 | —       |
| location         | 地点        | 文本 | —       |
| week             | 周序号       | 整数 | 指定修正周   |
| adjust\_quantity | 调整量（可正可负） | 整数 | 直接加到该周量 |

### 5.7 集成服务（orchestrator）视图
| 视图/口径  | 字段                            | 说明      | 格式 | 来源                                           |
| ------ | ----------------------------- | ------- | -- | -------------------------------------------- |
| 期初库存视图 | material, location, quantity  | 仿真日期初库存 | 整数 | orchestrator.get\_beginning\_inventory\_view |
| 生产GR视图 | material, location, quantity  | 仿真日生产入库 | 整数 | orchestrator.get\_production\_gr\_view       |
| 调运GR视图 | material, receiving, quantity | 仿真日调运入库 | 整数 | orchestrator.get\_delivery\_gr\_view         |

## 6. 输出数据
> 默认以 Excel 文件形式落盘：module1_output_YYYYMMDD.xlsx
### 6.1 OrderLog
| 字段               | 说明         | 格式            |
| ---------------- | ---------- | ------------- |
| date             | 订单到期日（交付日） | 日期            |
| material         | 物料         | 文本            |
| location         | 地点         | 文本            |
| demand\_type     | 订单类型       | 文本（AO/normal） |
| quantity         | 数量         | 整数            |
| simulation\_date | 生成日期       | 日期            |
| advance\_days    | 提前天数       | 整数（AO有值）      |

### 6.2 ShipmentLog
| 字段           | 说明             | 格式 |
| ------------ | -------------- | -- |
| date         | 发货日期（=仿真日）     | 日期 |
| material     | 物料             | 文本 |
| location     | 地点             | 文本 |
| quantity     | 发货量            | 整数 |
| demand\_type | 固定值 `customer` | 文本 |
| order\_id    | 当日生成的发货单号      | 文本 |

### 6.3 Cut
| 字段       | 说明         | 格式 |
| -------- | ---------- | -- |
| date     | 缺货日期（=仿真日） | 日期 |
| material | 物料         | 文本 |
| location | 地点         | 文本 |
| quantity | 缺货量        | 整数 |

### 6.4 SupplyDemandLog
| 字段              | 说明             | 格式 |
| --------------- | -------------- | -- |
| date            | 需求日期（>仿真日）     | 日期 |
| material        | 物料             | 文本 |
| location        | 地点             | 文本 |
| quantity        | 剩余预测量          | 整数 |
| demand\_element | 固定值 `forecast` | 文本 |

### 6.5 Summary
| 字段                  | 说明           | 格式    |
| ------------------- | ------------ | ----- |
| Total\_Orders       | 订单行数         | 整数    |
| Total\_Shipments    | 发货行数         | 整数    |
| Total\_SupplyDemand | 供需行数         | 整数    |
| Date                | 报表对应的订单到期日样本 | 日期/文本 |
