# Module 3 - MRP分层模拟业务逻辑梳理

## 1. 模块概述

Module 3是一个**物料需求计划(MRP)分层模拟模块**，主要负责：
- 基于供应链网络层级结构计算各节点的净需求
- 处理预测缺口和安全库存缺口
- 支持动态数据加载和每日版本管理
- 与Module 1、Module 4和Orchestrator集成

## 2. 核心业务概念

### 2.1 网络层级结构
- **根节点(Layer 0)**: 生产工厂(Plant)，自动识别或配置指定
- **中间节点**: 分销中心(DC)、仓库等
- **叶子节点**: 最终客户或销售点
- **层级关系**: 通过sourcing字段建立父子关系

### 2.2 缺口类型
- **Forecast Gap(预测缺口)**: 预测需求与实际可用量的差额
- **Safety Gap(安全库存缺口)**: 安全库存需求与实际可用量的差额

### 2.3 提前期计算
- **PDT**: 物理配送时间
- **GR**: 收货处理时间  
- **MCT**: 微生物检测时间(仅Plant)
- **Plant提前期**: max(MCT, PDT + GR)
- **DC提前期**: PDT + GR

## 3. 主要计算步骤

### 3.1 网络层级分配
```
1. 构建父子关系图
   - 从network_df读取sourcing和location字段
   - 建立children和parents字典

2. 识别根节点
   - 没有父节点的节点
   - 有下游但没有上游的节点

3. 广度优先遍历分配层级
   - 根节点: Layer 0
   - 子节点: Layer = 父节点Layer + 1

4. 处理孤立节点
   - 未连接的节点分配最高层级+1
```

### 3.2 净需求计算流程
```
1. 按层级从下往上处理(最高层级→最低层级)

2. 对每个节点计算当日净需求:
   a) 可用量计算:
      - 无限制库存
      - 在途库存  
      - 当日收货
      - 当日生产收货
      - 未来确认生产
      - 减去当日发货
      - 减去开放调拨

   b) 需求量计算:
      - 本节点预测需求(来自Module1)
      - 下游预测缺口
      - 下游安全库存缺口
      - 本地安全库存需求

   c) 缺口计算:
      - forecast_gap = max(总预测需求 - 总可用量, 0)
      - safety_gap = max(总安全需求 - 总可用量, 0) - forecast_gap

3. 缺口向上传递:
   - 将当前节点的gap累加到父节点
   - 按material-location组合聚合

4. 生成净需求记录:
   - requirement_date = 模拟日期 + 1天
   - quantity = -gap值(负值表示需求)
   - demand_element区分预测需求和安全库存需求
```

### 3.3 数据集成逻辑
```
1. 静态配置数据:
   - M3_SafetyStock: 安全库存配置
   - Global_Network: 网络配置(含location_type)
   - Global_LeadTime: 提前期配置

2. 动态数据(每日更新):
   - Module1: 供需数据和发货数据
   - Orchestrator: 库存、在途、收货、生产、调拨数据

3. 数据过滤策略:
   - 只处理模拟周期内的数据
   - 按日期动态加载Module1输出
   - 使用当日版本的Orchestrator视图
```

## 4. 关键业务规则

### 4.1 层级处理规则
- **自下而上**: 从最高层级开始，逐层向上传递缺口
- **聚合传递**: 同层级所有节点的gap先聚合，再传递给父节点
- **根节点处理**: 自动识别的根节点生成netdemand，不向上传递

### 4.2 时间处理规则
- **计算周期**: 基于提前期天数确定计算范围
- **需求日期**: requirement_date = 模拟日期 + 1天
- **数据版本**: 每日动态加载当天的Module1数据

### 4.3 数量计算规则
- **可用量**: 库存 + 在途 + 收货 + 生产 - 发货 - 调拨
- **需求量**: 预测需求 + 下游缺口 + 安全库存
- **缺口值**: 需求 - 可用量，最小值为0

## 5. 输出数据结构

### 5.1 NetDemand记录字段
```python
{
    'material': '物料编码',
    'location': '地点编码', 
    'requirement_date': '需求日期',
    'quantity': '需求数量(负值)',
    'demand_element': '需求类型',
    'layer': '网络层级',
    'simulation_date': '模拟日期',
    'horizon_days': '提前期天数'
}
```

### 5.2 需求类型分类
- **Distribution Demand - Forecast**: 预测需求缺口
- **Distribution Demand - Safety Stock**: 安全库存缺口

## 6. 集成接口

### 6.1 输入接口
- **Module1**: SupplyDemandLog, ShipmentLog, OrderLog
- **Module4**: ProductionPlan(生产计划)
- **Orchestrator**: 各种库存和物流视图
- **配置**: 安全库存、网络、提前期配置

### 6.2 输出接口
- **每日Excel文件**: Module3Output_YYYYMMDD.xlsx
- **NetDemand表**: 包含所有净需求记录
- **向下游传递**: 为Module4提供需求输入

## 7. 异常处理机制

### 7.1 数据缺失处理
- 配置文件缺失时使用默认值
- 数据加载失败时使用空DataFrame
- 网络配置缺失时自动识别层级

### 7.2 计算异常处理
- 日期转换失败时抛出TypeError
- 提前期计算失败时使用默认值1天
- 净需求计算失败时返回(0.0, 0.0)

## 8. 性能优化策略

### 8.1 数据处理优化
- 按日期过滤数据，减少内存占用
- 使用pandas高效操作进行数据聚合
- 避免重复计算，缓存中间结果

### 8.2 算法优化
- 广度优先遍历避免重复访问
- 层级聚合减少数据传递次数
- 批量处理提高计算效率

## 9. 业务价值

### 9.1 供应链优化
- 识别各节点的真实需求缺口
- 支持多层级库存优化决策
- 提供准确的补货计划依据

### 9.2 运营效率提升
- 自动化需求计算，减少人工干预
- 实时响应供应链变化
- 支持滚动计划更新

### 9.3 成本控制
- 避免过度库存和缺货
- 优化补货时机和数量
- 支持安全库存动态调整


